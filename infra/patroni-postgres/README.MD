# üìÑ Configura√ß√£o do Cluster Patroni PostgreSQL

## üåü Vis√£o Geral

Este diret√≥rio cont√©m a configura√ß√£o para implantar um cluster PostgreSQL de **Alta Disponibilidade (HA)** utilizando Patroni e Docker Compose.

A abordagem de configura√ß√£o foi projetada para ser robusta, segura e extremamente flex√≠vel, permitindo o uso em diferentes ambientes (desenvolvimento, produ√ß√£o) com o m√≠nimo de altera√ß√µes.

## üèõÔ∏è Filosofia de Configura√ß√£o: Planta e Acabamentos

Este projeto adota uma filosofia de **"Planta e Acabamentos"** para m√°xima clareza e seguran√ßa:

1.  **A "Planta" (`patroni.yml`):**

      * √â o **esqueleto arquitet√¥nico** do nosso cluster. Cont√©m todas as configura√ß√µes estruturais e de performance que s√£o est√°veis e compartilhadas entre todos os n√≥s.
      * Este arquivo possui valores padr√£o seguros, permitindo que funcione "sozinho", mas foi projetado para ser "personalizado" pelos acabamentos.
      * Este arquivo **pode e deve** ser versionado no Git.

2.  **Os "Acabamentos" (Arquivos `.env`):**

      * Cont√™m os **detalhes, segredos e configura√ß√µes espec√≠ficas** do ambiente. √â aqui que voc√™ define senhas, nomes de cluster e ajusta a performance para um ambiente espec√≠fico.
      * Estes arquivos **NUNCA** devem ser versionados no Git.

## üìÇ Estrutura dos Arquivos

### blueprints `patroni.yml`

  * **Fun√ß√£o:** A "Planta" do cluster.
  * **Cont√©m:** Configura√ß√µes de performance (`shared_buffers`, etc.), regras de bootstrap, `pg_hba` e a estrutura geral do Patroni.
  * **Flexibilidade:** Utiliza a sintaxe `${VARIAVEL:-valor_padr√£o}`. Isso significa que ele usar√° um valor padr√£o seguro, a menos que uma vari√°vel de ambiente com o mesmo nome seja fornecida.

### üîë `config/.patroni.env`

  * **Fun√ß√£o:** Os "Acabamentos" compartilhados por todos os n√≥s do cluster.
  * **Cont√©m:** **Segredos** (senhas de superusu√°rio, replica√ß√£o, API) e configura√ß√µes que se aplicam a todos os n√≥s em um ambiente espec√≠fico (ex: `PATRONI_SCOPE`, `PATRONI_ETCD3_HOSTS`).

### üê≥ `docker-compose.yaml`

  * **Fun√ß√£o:** O orquestrador que monta o cluster.
  * **Cont√©m:** A defini√ß√£o dos servi√ßos (n√≥s do Patroni, etcd, etc.). √â l√° que definimos a **identidade √∫nica** de cada n√≥ do cluster (como o nome do cont√™iner), que n√£o pode ser compartilhada.
  * **Exemplo:** A vari√°vel `PATRONI_NAME` √© definida na se√ß√£o `environment` de cada servi√ßo dentro deste arquivo, pois cada n√≥ deve ter um nome exclusivo.

## ü•á Hierarquia de Configura√ß√£o (Regra de Prioridade)

√â fundamental entender que, se uma configura√ß√£o for definida em m√∫ltiplos lugares, o Patroni sempre priorizar√° a vari√°vel de ambiente. A ordem √©:

1.  **M√°xima Prioridade:** Vari√°veis na se√ß√£o `environment` de um servi√ßo no `docker-compose.yaml`. (Ex: `PATRONI_NAME`).
2.  **M√©dia Prioridade:** Vari√°veis carregadas pelo `env_file` (seu `config/patroni.env`).
3.  **Baixa Prioridade:** Os valores padr√£o definidos diretamente no arquivo `patroni.yml`.

Em resumo: **o que est√° nos arquivos `.env` sempre sobrescreve o que est√° na "planta" (`patroni.yml`)**.

## üöÄ Como Usar

A utiliza√ß√£o √© projetada para ser o mais simples poss√≠vel:

1.  **(Opcional) Revise a "Planta"**: Entenda as configura√ß√µes padr√£o e de performance no arquivo `patroni.yml`. Em geral, voc√™ n√£o precisar√° alter√°-lo.
2.  **‚úÖ Personalize os "Acabamentos"**: Este √© o passo principal. Abra o arquivo `config/.patroni.env` e ajuste as senhas, o nome do cluster (`PATRONI_SCOPE`) e os par√¢metros de performance conforme a necessidade do seu ambiente.
3.  **üöÄ Implante o Cluster**: Execute o comando para subir os servi√ßos.
    ```bash
    docker-compose up -d
    ```

O Docker Compose cuidar√° de injetar as vari√°veis nos cont√™ineres corretos, e o Patroni aplicar√° a configura√ß√£o final com a hierarquia correta.