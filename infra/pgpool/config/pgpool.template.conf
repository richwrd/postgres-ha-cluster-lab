# =============================================================================
# Arquivo de Template para pgpool.conf (Revisado e Aprimorado)
# Adaptado para um ambiente dinâmico com Patroni
# Autor: Eduardo Richard
# =============================================================================

# --- CONFIGURAÇÕES DE CONEXÃO E PCP ---
listen_addresses = '*'
port = 5432

# Tamanho da fila de conexões TCP pendentes (crítico para burst de 100 clientes)
# Default é 128, aumentando para 1024 para evitar connection refused
listen_backlog = 256
# Número de clientes que podem esperar na fila quando todos os processos estão ocupados
listen_backlog_multiplier = 2

# Número de conexões reservadas para super usuários
reserved_connections = 5

# --- CONFIGURAÇÃO SSL ---
ssl = off

# --- PCP (Pgpool Control Protocol) ---
pcp_listen_addresses = '*'
pcp_port = 9898

# Aponta os arquivos de runtime para o diretório efêmero padrão do Linux.
# O entrypoint.sh garante que este diretório seja criado e permissionado.
pid_file_name = '/var/run/pgpool/pgpool.pid'
socket_dir = '/var/run/pgpool'
pcp_socket_dir = '/var/run/pgpool'

# --- CONFIGURAÇÃO DOS BACKENDS (SERÁ PREENCHIDA DINAMICAMENTE) ---
##BACKEND_NODES_CONFIG##

# --- MODOS DE OPERAÇÃO E BALANCEAMENTO DE CARGA ---
backend_clustering_mode = 'streaming_replication'
load_balance_mode = on

# CRÍTICO: dml_adaptive para workload MIXED com async replication
# Para SELECT-only, esse parâmetro não tem efeito
disable_load_balance_on_write = 'dml_adaptive'


replication_mode = off
enable_pool_hba = on
pool_hba_conf_file = '/opt/pgpool/etc/pool_hba.conf'


# --- POOLING DE CONEXÃO E PERFORMANCE (TUNING) ---
# Número de processos filhos pré-forkados. Um valor maior permite mais conexões simultâneas.
num_init_children = ${PGPOOL_NUM_INIT_CHILDREN:-125}
# Máximo de conexões simultâneas permitidas.
max_pool = ${PGPOOL_MAX_POOL:-2}

# Tempo de vida de um processo filho (0 = infinito, recomendado para testes)
child_life_time = 300
# Timeout de cliente ocioso (30 minutos)
client_idle_limit = 1800
# Limite de conexões por processo filho (0 = sem limite)
child_max_connections = 0

# Habilita cache de conexões para melhorar performance
connection_cache = on

# Modo de serialização de transações (off para melhor performance)
# Se ativado, o pgpool serializa as transações para evitar conflitos
# em ambientes com múltiplas réplicas. Desativado para melhor performance.
serialize_accept = off

# Balanceamento de carga para instruções DML e transações
# para cada instrução SQL, o pgpool decide se envia para master ou replica
statement_level_load_balance = off  # on causa overhead, off é mais rápido

# Timeouts mais tolerantes para burst de 100 conexões
connection_life_time = 0
authentication_timeout = 30
allow_sql_comments = on
ignore_leading_white_space = on

# --- CHECAGEM DE REPLICAÇÃO (STREAMING REPLICATION CHECK) ---
# Aumentado para reduzir overhead durante alta carga
sr_check_period = 30
sr_check_user = replicator
sr_check_password = ''
sr_check_database = postgres

# --- CHECAGEM DE SAÚDE (HEALTH CHECK) - AJUSTADO PARA ALTA CARGA ---
# Período entre health checks (aumentado para reduzir overhead)
health_check_period = 30
# Timeout para resposta do backend (aumentado para evitar falsos positivos)
health_check_timeout = 10
# Máximo de tentativas antes de marcar backend como down
health_check_max_retries = 5
# Delay entre retentativas (aumentado)
health_check_retry_delay = 3
health_check_user = healthchecker
health_check_password = ''
health_check_database = postgres

pool_passwd = '/opt/pgpool/pool_passwd'

# --- FAILOVER E FAILBACK (AUTOMATIZADO VIA HOOKS) ---
failover_on_backend_error = on
fail_over_on_backend_shutdown = on
failover_command = '/opt/pgpool/bin/scripts/hooks/failover.sh %d %H %p %D %m %M %P %r %R'
follow_primary_command = '/opt/pgpool/bin/scripts/hooks/follow_primary.sh %d %H %p %D %m %M %P %r %R'
failback_command = ''

# --- LOGGING (CONFIGURADO PARA CONTAINERS) ---
logging_collector = off
log_destination = 'stderr'
log_connections = off
log_statement = off
log_hostname = off
client_min_messages = warning
log_min_messages = warning
log_error_verbosity = verbose
