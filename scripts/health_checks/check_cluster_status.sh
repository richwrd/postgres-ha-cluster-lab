#!/bin/bash
# ------------------------------------------------------------------------------------
# Script consolidado para verificaรงรฃo de status do cluster PostgreSQL HA
# Testa: ETCD, Patroni e PGPool
# 
# Estrutura Modular:
#   - etcd.sh     : Testes do cluster ETCD
#   - patroni.sh  : Testes do cluster Patroni PostgreSQL
#   - pgpool.sh   : Testes do PGPool-II (connection pooling e load balancing)
#
# by: richwrd
# ------------------------------------------------------------------------------------

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โโ Carregar bibliotecas de ambiente
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/../lib/env.sh"
source "${SCRIPT_DIR}/../lib/logging.sh"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โโ Carregar mรณdulos de testes especรญficos
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

source "${SCRIPT_DIR}/etcd.sh"
source "${SCRIPT_DIR}/patroni.sh"
source "${SCRIPT_DIR}/pgpool.sh"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โโ Variรกveis globais
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

declare -a ETCD_INSTANCES
declare -a PATRONI_INSTANCES
declare PATRONI_PRIMARY
declare PGPOOL_CONTAINER
declare COMPOSE_FILE
declare ETCD_ENDPOINTS

declare TEST_DB="postgres"

# Contadores de testes
declare TOTAL_TESTS=0
declare PASSED_TESTS=0
declare FAILED_TESTS=0

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โโ Funรงรตes auxiliares de contagem
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

increment_test() {
    ((TOTAL_TESTS++))
}

test_passed() {
    ((PASSED_TESTS++))
}

test_failed() {
    ((FAILED_TESTS++))
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โโ Carregar variรกveis de ambiente
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

load_cluster_vars() {
    log_info "Carregando variรกveis de ambiente do cluster..."
    
    # Carregar ETCD
    ETCD_INSTANCES=()
    local idx=1
    while true; do
        local var_name="ETCD${idx}_NAME"
        local instance_name="${!var_name}"
        
        if [ -z "${instance_name}" ]; then
            break
        fi
        
        ETCD_INSTANCES+=("${instance_name}")
        ((idx++))
    done
    
    # Construir endpoints ETCD
    local endpoints=""
    for instance in "${ETCD_INSTANCES[@]}"; do
        if [ -z "$endpoints" ]; then
            endpoints="http://${instance}:2379"
        else
            endpoints="${endpoints},http://${instance}:2379"
        fi
    done
    ETCD_ENDPOINTS="${endpoints}"
    export ETCD_ENDPOINTS
    
    # Carregar Patroni
    PATRONI_INSTANCES=()
    idx=1
    while true; do
        local var_name="PATRONI${idx}_NAME"
        local instance_name="${!var_name}"
        
        if [ -z "${instance_name}" ]; then
            break
        fi
        
        PATRONI_INSTANCES+=("${instance_name}")
        ((idx++))
    done
    
    # Carregar PGPool
    PGPOOL_CONTAINER="${PGPOOL_NAME}"
    
    echo ""
    echo "  ๐ Configuraรงรฃo do cluster:"
    echo "     โข Instรขncias ETCD: ${#ETCD_INSTANCES[@]}"
    echo "     โข Instรขncias Patroni: ${#PATRONI_INSTANCES[@]}"
    echo "     โข Container PGPool: ${PGPOOL_CONTAINER}"
    echo "     โข Usuรกrio DB: ${TEST_DB_USERNAME:-<nรฃo definido>}"
    echo ""
    
    log_success "Variรกveis de ambiente carregadas"
}


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โโ Exibir cabeรงalho
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

show_header() {
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "  ๐ VERIFICAรรO DE STATUS DO CLUSTER POSTGRESQL HA"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "  Data/Hora: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "  Compose File: ${COMPOSE_FILE}"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โโ Exibir resumo final
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

show_summary() {
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "  ๐ RESUMO DA VERIFICAรรO"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    
    # Calcular percentual de sucesso
    local success_percent=0
    if [ $TOTAL_TESTS -gt 0 ]; then
        success_percent=$((PASSED_TESTS * 100 / TOTAL_TESTS))
    fi
    
    echo "  ๐ Estatรญsticas:"
    echo "     โข Total de testes: ${TOTAL_TESTS}"
    echo "     โข Testes passados: ${PASSED_TESTS} (${success_percent}%)"
    echo "     โข Testes falhados: ${FAILED_TESTS}"
    echo ""
    
    echo "  ๐ง Componentes:"
    echo "     โข ETCD: ${#ETCD_INSTANCES[@]} instรขncia(s)"
    echo "     โข Patroni: ${#PATRONI_INSTANCES[@]} instรขncia(s)"
    echo "     โข PGPool: 1 instรขncia"
    echo ""
    
    if [ $FAILED_TESTS -eq 0 ]; then
        echo "  โ STATUS GERAL: TODOS OS TESTES PASSARAM"
        echo "  ๐ Cluster estรก operacional e saudรกvel!"
    elif [ $FAILED_TESTS -lt 3 ]; then
        echo "  โ๏ธ  STATUS GERAL: ALERTAS DETECTADOS"
        echo "  โก Cluster operacional com alguns problemas menores"
    else
        echo "  โ STATUS GERAL: PROBLEMAS CRรTICOS DETECTADOS"
        echo "  ๐จ Cluster requer atenรงรฃo imediata!"
    fi
    
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    
    # Retornar cรณdigo de saรญda apropriado
    if [ $FAILED_TESTS -eq 0 ]; then
        return 0
    else
        return 1
    fi
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โโ Funรงรฃo principal
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

main() {
    # Carregar ambiente
    load_env
    
    # Definir arquivo docker-compose
    COMPOSE_FILE="${COMPOSE_FILE:-${PROJECT_ROOT}/docker-compose.yaml}"
    
    # Carregar variรกveis do cluster
    load_cluster_vars
    
    # Exibir cabeรงalho
    show_header
    
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # TESTES ETCD
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ ๐ท TESTES DO ETCD                                           โ"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    
    test_etcd_containers
    echo ""
    
    test_etcd_health
    echo ""
    
    test_etcd_write_read
    echo ""
    
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # TESTES PATRONI
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ ๐ท TESTES DO PATRONI                                        โ"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    
    test_patroni_containers
    echo ""
    
    identify_patroni_primary
    echo ""
    
    test_patroni_health
    echo ""
    
    test_patroni_replication
    echo ""
    
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # TESTES PGPOOL
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ ๐ท TESTES DO PGPOOL                                         โ"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    
    test_pgpool_container
    echo ""
    
    # Detectar credenciais vรกlidas antes de continuar
    detect_pgpool_credentials
    echo ""
    
    test_pgpool_connection
    echo ""
    
    test_pgpool_backends
    echo ""
    
    test_pgpool_load_balancing
    echo ""
    
    test_pgpool_write_operations
    echo ""
    
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    # RESUMO FINAL
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    show_summary
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โโ Executar script
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

main "$@"

exit_code=$?
exit $exit_code
